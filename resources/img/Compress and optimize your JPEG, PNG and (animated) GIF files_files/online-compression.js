function checkImageOptimized(e,i,a,t,n,o=null){var s=e.data("retry-count");if(s>70){$(".loading-spinner2",e).remove();e.removeClass("dz-success");e.addClass("dz-error");$(".dz-error-message",e).text("The image optimization timed out. Please retry.");return}e.data("retry-count",1+s);$.ajax({url:"/file-upload",type:"POST",data:{fileURL:i,compressionType:a,keep_exif:o["keep_exif"],cmyk2rgb:o["cmyk2rgb"],resize:o["resize"],width:o["width"],height:o["height"]},success:function(s,l){var d=JSON.parse(s)[0];if(typeof d=="undefined"){setTimeout((function(){checkImageOptimized(e,i,a,t,n,o)}),2e3)}else{handleResponse(e,d,n,t)}},error:function(s,l,d){setTimeout((function(){checkImageOptimized(e,i,a,t,n,o)}),1e3)}})}var clickOnImageMsg=false;function handleResponse(e,i,a,t){var n=i.Data;if(i.Status=="success"){if(typeof n.OptimizedFileName=="undefined"&&typeof t!=="undefined"){n.OptimizedFileName=t}if(n.Status.Code=="2"&&0+n.LossySize>=0){n.OriginalURL=n.OriginalURL.replace("http://","https://");var o=n.CompressionType==0?n.LosslessURL:n.LossyURL;o=o.replace("http://","https://");var s=n.CompressionType==0?n.LoselessSize:n.LossySize;var l=100*(1-s/n.OriginalSize);if(0+l>0){var d=a.filesize(n.OriginalSize);var r=a.filesize(s);$("div.dz-size span.span-size",e).html("<strong>"+Math.round(l)+"</strong>");var p="Keep Exif:";if(n.Settings.keep_exif==1){p+="YES"}else{p+="NO"}p+=", CMYK to RGB:";if(n.Settings.cmyk2rgb==1){p+="YES"}else{p+="NO"}if(n.Settings.resize>0){p+=", Width:"+n.Settings.width;p+=", Height:"+n.Settings.height;if(n.Settings.resize==3){p+=", Resize type: Smaller than both"}if(n.Settings.resize==1){p+=", Resize type: Smaller than one"}}$("div.dz-size span.span-size",e).attr("title",p);$("div.dz-size span.percent-sign",e).html("%");$("div.dz-filename span.sizes",e).html("<span style='font-size:10px;'>"+d+" <span class='glyphicon glyphicon-arrow-right'></span> "+r+"</span>");$("div.dz-type",e).html(n.CompressionType=="1"?"Lossy":n.CompressionType=="2"?"Glossy":"Lossless");var m=n.OriginalURL.split("/");var u=$("div.dz-filename .optimized-download",e);u.attr("href",o+"/"+encodeURIComponent(n.OptimizedFileName));u.addClass("optimized-download-active");u.attr("title","Download optimized image for "+n.OptimizedFileName);u.css("display","inline");if(n.OptimizedFileName.substr(n.OptimizedFileName.lastIndexOf(".")+1).toLowerCase()=="pdf"){var c=$(".dz-image",e);c.attr("title",n.OptimizedFileName)}else{var f=$(".optimized-view",e);f.data("original",n.OriginalURL);f.data("optimized",o);f.data("optimizeTime",Math.round((new Date).getTime()/1e3));f.attr("title","Compare images for "+n.OptimizedFileName+" (original vs. lossy)");f.css("display","inline");if(!clickOnImageMsg){clickOnImageMsg=true;$(".dropzone-info").fadeIn(600);setTimeout((function(){$(".dropzone-info").fadeOut(800)}),6e3)}f.click((function(e){displayOptimizationComparerPopup(f.data("optimizeTime"),f.data("width"),f.data("height"),$(this).data("original"),$(this).data("optimized"),n.Settings);e.preventDefault()}))}var g=$("a.optimized-download-active").length;if(g>1){$("#download-buttons").css("display","block");$("button.dropzone-download-all span.compresssed-file-count").html(g);$("button.dropzone-download-all").data("url",false)}}else{$("div.dz-size span.span-size",e).html("<span class='glyphicon glyphicon-thumbs-up' title='Image already has the optimal size' style='margin-top: 6px;'></span>");$("div.dz-filename span.sizes",e).html("<span style='font-size: 12px'>Already optimal</span>")}}$("div.dz-details",e).css("opacity","1")}else if(i.Status=="retry"||typeof n!=="undefined"&&0+n.LossySize==0){$("div.dz-size span.span-size",e).html("<img src='/img/spinner2.gif' class='loading-spinner2' width='50' title='Optimizing ... '/>");$("div.dz-details",e).css("opacity","1");if(typeof n.OptimizedFileName=="undefined"&&typeof t!=="undefined"){n.OptimizedFileName=t}var h=e.data("retry-count");var z=h<15?1e3:h<35?5e3:15e3;setTimeout((function(){checkImageOptimized(e,n.OriginalURL,n.CompressionType,n.OptimizedFileName,a,n.Settings)}),z)}else if(i.Status=="error"){if(n){$(".loading-spinner2",e).remove();e.removeClass("dz-success");e.addClass("dz-error");$(".dz-error-message",e).text(n.Status.Message)}}}function displayOptimizationComparerPopup(e,i,a,t,n,o=null){if(Math.round((new Date).getTime()/1e3)-e>1800){alert("Timeout reached. Please redo the optimizations.")}var s=i;var l=a<150||i<350;if(o!=null&&o["resize"]>0&&(o["height"]<150||o["width"]<350)){l=true}var d=$(l?"#uploadCompareSideBySide":"#uploadCompare");if(l){}console.log("sideBySide",l);if(!l){$("#compareSlider").html('<img id="uploadCompareOriginal" class="uploadCompareOriginal"/><img id="uploadCompareOptimized" class="uploadCompareOptimized"/>')}var r=Math.max(300,Math.round(.8*Math.max(document.documentElement.clientWidth,window.innerWidth||0)));i=Math.max(350,Math.min(r,i<350?(i+25)*2:a<150?i+25:i));a=Math.max(150,l?s>350?2*(a+45):a+45:a*i/s);if(l){i=350;a=150}$(".modal-dialog",d).css("width",i);$(".shortpixel-slider",d).css("width",i);$(".modal-body",d).css("height",a);d.modal("show");var p=$(".uploadCompareOptimized",d);$(".uploadCompareOriginal",d).attr("src",t);setTimeout((function(){$(window).trigger("resize")}),1e3);p.on("load",(function(){$(window).trigger("resize")}));p.attr("src",n);setTimeout((function(){if(o!=null&&o["resize"]>0){var e=document.getElementById("uploadCompareOptimized").offsetWidth;var i=document.getElementById("uploadCompareOptimized").offsetHeight;document.getElementById("uploadCompareOriginal").style.width=e+"px";document.getElementById("uploadCompareOriginal").style.height=i+"px";console.log(e);setTimeout((function(){$(window).trigger("resize")}),1e3);p.on("load",(function(){$(window).trigger("resize")}));$(".modal-dialog",d).css("width",e+"px");$(".shortpixel-slider",d).css("width",e+"px");$(".modal-body",d).css("height",i+"px")}}),500)}function initOnlineCompressionDropzone(e,i,a){a=typeof a!=="undefined"?a:false;var t=new Dropzone("#demo-dropzone",{previewTemplate:$("#preview-template").html(),thumbnailWidth:180,thumbnailHeight:180,acceptedFiles:"image/jpeg,image/gif,image/png,.pdf",maxFiles:e,parallelUploads:10,maxFilesize:a?100:10,maxThumbnailFilesize:a?50:10,dictDefaultMessage:i,dictInvalidFileType:"Please only select JPG, GIF, PNG images or PDF documents",dictMaxFilesExceeded:"You can optimize maximum 50 pictures. Please reload the page to optimize more images."});$("input[name=comp-level]").change((function(){$("input[name=compressionType]").val($("input[name=comp-level]:checked").val())}));$("input[name=exif]").change((function(){$("input[name=keep_exif]").val($("input[name=exif]:checked").val())}));$("input[name=cmykrgb]").change((function(){$("input[name=cmyk2rgb]").val($("input[name=cmykrgb]:checked").val())}));$("input[name=resizetype]").change((function(){$("input[name=resize]").val($("input[name=resizetype]:checked").val())}));$("input[name=maxwidth]").change((function(){$("input[name=width]").val($("input[name=maxwidth]").val())}));$("input[name=maxheight]").change((function(){$("input[name=height]").val($("input[name=maxheight]").val())}));if(e<=0){t.disable()}else{t.on("success",(function(e,i){console.log("success!! Response: ".resp);handleResponse($(e.previewElement),JSON.parse(i)[0],this)}));t.on("addedfile",(function(e){if(e.name.substr(e.name.lastIndexOf(".")+1).toLowerCase()=="pdf"){$(".dz-image",$(e.previewElement)).css("background-image","url('https://shortpixel.com/img/adobe-pdf-logo.png')")}}));t.on("thumbnail",(function(e){var i=$(".optimized-view",$(e.previewElement));i.data("width",e.width);i.data("height",e.height)}))}$("#uploadCompare").on("shown.bs.modal",(function(){$("#compareSlider").twentytwenty({slider_move:"mousemove"})}));$("#login-form").submit((function(e){$("#login-form input").removeClass("input_error");$.ajax({url:"/login-ajax",type:"POST",data:{email:$("#login-form input[name=email]").val(),password:$("#login-form input[name=password]").val(),submit:"login"},success:function(e,i){var a=JSON.parse(e);if(typeof a!=="undefined"){if(a.Status=="success"){$("#loginModal").modal("hide");$("button.dropzone-download-all").attr("title","Download all images as a zip archive.");$("#menu-signup").html('<a href="/menu">Admin</a>');$("#menu-login").remove();n()}else if(a.Status=="error"||a.Status=="invalid"){$("#login-form input[name=password]").attr("placeholder",a.Message);$("#login-form input[name=password]").val("");if(a.Status=="invalid"){$("#login-form input[name=email]").addClass("input_error")}else{$("#login-form input[name=password]").addClass("input_error")}}}},error:function(e,i,a){}});e.preventDefault();return false}));var n=function(){var e=$("#download-desktop");var i=e.data("url");if(typeof i!==typeof undefined&&i!==false){window.downloadFile(i);return}e.html("Preparing ...");var a=$("a.optimized-download-active");var t=[];for(var n=0;n<a.length;n++){t[n]=$(a[n]).attr("href")}$.ajax({url:"/create-archive",type:"POST",data:{fileURLs:t},success:function(i,a){var n=JSON.parse(i);if(typeof n!=="undefined"){if(n.Status=="success"){e.data("url",n.Url);window.downloadFile(n.Url)}else if(n.Status=="login"){$("#loginModal").modal("show")}else if(n.Status=="credits"){$("#credits-available").text(Math.max(0,n.CreditsAvailable));$("#creditsModal").modal("show")}}e.html("Download <span id='compresssed-file-count'>"+t.length+"</span> files")},error:function(i,a,n){e.html("Download "+t.length+" files")}})};$("button.dropzone-download-all").click(n)}window.downloadFile=function(e){if(window.downloadFile.isChrome||window.downloadFile.isSafari){var i=document.createElement("a");i.href=e;if(i.download!==undefined){var a=e.substring(e.lastIndexOf("/")+1,e.length);i.download=a}if(document.createEvent){var t=document.createEvent("MouseEvents");t.initEvent("click",true,true);i.dispatchEvent(t);return true}}var n="?download";window.open(e+n)};window.downloadFile.isChrome=navigator.userAgent.toLowerCase().indexOf("chrome")>-1;window.downloadFile.isSafari=navigator.userAgent.toLowerCase().indexOf("safari")>-1;